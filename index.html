<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Aires éducatives — Académie de Nice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

<style>
body { margin:0; font-family:Segoe UI, Arial; }
#map { height:100vh; }
.header {
    position:absolute; top:15px; left:60px; z-index:1000;
    background:white; padding:12px 18px; border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    font-size:20px; font-weight:bold;
}
.filter {
    position:absolute; top:80px; left:60px; z-index:1000;
    background:white; padding:10px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.legend {
    background:white; padding:10px; border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
</style>
</head>

<body>
<div class="header">Académie de Nice — Aires éducatives</div>

<!-- Filtres -->
<div class="filter">
    <label><input type="checkbox" id="ameCheckbox" checked> AME</label><br>
    <label><input type="checkbox" id="ateCheckbox" checked> ATE</label>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// =======================
// INITIALISATION CARTE
// =======================
var map = L.map('map').setView([43.8, 6.3], 8);

// Relief et Satellite
var relief = L.tileLayer(
    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    { attribution: '© OpenTopoMap' }
);

var satellite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution: '© Esri' }
).addTo(map); // <-- Satellite par défaut

L.control.layers({
    "Relief": relief,
    "Satellite": satellite
}).addTo(map);

// =======================
// CLUSTERS
// =======================
var ameCluster = L.markerClusterGroup();
var ateCluster = L.markerClusterGroup();

// =======================
// LECTURE CSV
// =======================
fetch("https://ycastel.github.io/carte-aires-educatives/donnees.csv")
.then(response => response.text())
.then(function(text){
    var lignes = text.split("\n");

    for(var i=1; i<lignes.length; i++){
        if(!lignes[i]) continue;

        var cols = lignes[i].split(";");
        if(cols.length < 9) continue;

        var nom = cols[0];
        var adresse = cols[1];
        var cp = cols[2];
        var commune = cols[3];
        var ame = cols[4];
        var ate = cols[5];
        var site = cols[6];
        var lon = parseFloat(cols[7].replace(",", "."));
        var lat = parseFloat(cols[8].replace(",", "."));

        if(isNaN(lat) || isNaN(lon)) continue;

        var popup =
            "<b>"+nom+"</b><br>"+
            adresse+"<br>"+
            cp+" "+commune+"<br>"+
            (site ? "<a href='"+site+"' target='_blank'>Site web</a>" : "");

        if(ame === "1"){
            var marker = L.circleMarker([lat, lon], {
                radius:8, fillColor:"#007bff", color:"white", weight:1, fillOpacity:0.9
            });
            marker.bindPopup(popup);
            ameCluster.addLayer(marker);
        }

        if(ate === "1"){
            var marker = L.circleMarker([lat, lon], {
                radius:8, fillColor:"#28a745", color:"white", weight:1, fillOpacity:0.9
            });
            marker.bindPopup(popup);
            ateCluster.addLayer(marker);
        }
    }

    map.addLayer(ameCluster);
    map.addLayer(ateCluster);
});

// =======================
// FILTRES INTERACTIFS
// =======================
document.getElementById("ameCheckbox").addEventListener("change", function(){
    if(this.checked) map.addLayer(ameCluster);
    else map.removeLayer(ameCluster);
});

document.getElementById("ateCheckbox").addEventListener("change", function(){
    if(this.checked) map.addLayer(ateCluster);
    else map.removeLayer(ateCluster);
});

// =======================
// LEGENDE
// =======================
var legend = L.control({position:"bottomright"});
legend.onAdd = function(){
    var div = L.DomUtil.create("div","legend");
    div.innerHTML = "<b>Légende</b><br>"+
                    "<span style='color:#007bff;'>●</span> AME<br>"+
                    "<span style='color:#28a745;'>●</span> ATE";
    return div;
};
legend.addTo(map);

</script>
</body>
</html>
